# План исправления уязвимостей безопасности

> **Дата:** 29.11.2025  
> **Проект:** store-reviews-parser  
> **Статус:** ✅ Основные проблемы исправлены

---

## ⚠️ Важное замечание

**Netlify больше не используется.** ✅ Все упоминания Netlify удалены:
- ~~Удалить папку `netlify/functions/`~~ ✅
- ~~Удалить проверки `isNetlify` / `AWS_LAMBDA_FUNCTION_NAME` из кода~~ ✅
- ~~Удалить `serverless-http` из зависимостей~~ ✅
- ~~Обновить CORS и логирование (убрать Netlify-специфичную логику)~~ ✅

---

## Критичные проблемы (P0)

### 1. SQLite никогда не загружается — данные хранятся только в памяти

**Файл:** `packages/api/src/database/database.ts` (строки 7-17)

**Проблема:**
- Переменная `sqlite3` объявлена как `null` и никогда не инициализируется
- Условие `this.inMemory = isNetlify || !sqlite3` всегда `true`
- Массив `memReviews` растёт неограниченно
- Каждый запрос копирует и сортирует весь массив

**Последствия:**
- Данные теряются при рестарте сервера
- Исчерпание RAM/CPU после нескольких парсингов
- DoS при небольшой нагрузке

**План исправления:** ✅ ВЫПОЛНЕНО
- [x] Реализовать динамический импорт sqlite3
- [x] Добавить лимит на размер `memReviews` (10000)
- [x] Сортировка при сохранении, не при запросе
- [x] Автоматическое удаление старых отзывов при превышении лимита

---

### 2. Публичный `/parse` без аутентификации и rate-limiting

**Файл:** `packages/api/src/routes/api.ts` (строки 43-80)

**Проблема:**
- Эндпоинт доступен без авторизации
- Нет ограничения частоты запросов
- Один вызов запускает до 200 параллельных запросов к Apple и до 5000 отзывов от Google

**Последствия:**
- Злоумышленник может перегрузить сервер
- Риск бана со стороны Apple/Google
- Исчерпание исходящих соединений

**План исправления:** ✅ ЧАСТИЧНО ВЫПОЛНЕНО
- [x] Добавить middleware для rate-limiting (express-rate-limit)
  - Глобальный: 100 req/min
  - /parse: 5 req/min
  - /export: 10 req/min
  - /search: 30 req/min
- [ ] Добавить базовую аутентификацию (API-ключ или JWT)
- [ ] Ограничить количество параллельных задач парсинга
- [ ] Добавить очередь задач для тяжёлых операций

---

## Высокий приоритет (P1)

### 3. `/reviews` и `/export` без ограничения limit/total

**Файл:** `packages/api/src/routes/api.ts` (строки 97-209)

**Проблема:**
- Клиент может передать произвольные значения `limit` и `total`
- Результаты полностью собираются в памяти
- Экспорт создаёт Buffer для всего набора данных

**План исправления:** ✅ ВЫПОЛНЕНО
- [x] Установить максимальный `limit` (1000)
- [x] Установить максимальный `total` для экспорта (10000)
- [ ] Реализовать стриминг для больших экспортов
- [x] Добавить валидацию числовых параметров

---

### 4. CORS открыт в продакшене

**Файл:** `packages/api/src/app.ts` (строки 20-32)

**Проблема:**
- Без `ALLOWED_ORIGINS` возвращается `'*'`
- Комбинация `origin: '*'` + `credentials: true` некорректна
- Сторонние сайты могут использовать API

**План исправления:**
- [ ] Удалить Netlify-специфичную логику
- [ ] Сделать `ALLOWED_ORIGINS` обязательным в продакшене
- [ ] Убрать `credentials: true` если не требуется
- [ ] Добавить проверку Origin в runtime

---

### 5. Singleton Database в serverless-контексте

**Файл:** `packages/api/src/routes/api.ts` (строки 8-9)

**Проблема:**
- `ReviewService` и `ExportService` создаются один раз на уровне модуля
- Race condition между запросами
- Непредсказуемое поведение при hot reload

**План исправления:**
- [ ] Удалить Netlify/serverless специфику (больше не актуально)
- [ ] Рассмотреть dependency injection или factory pattern
- [ ] Добавить proper connection pooling для SQLite

---

## Средний приоритет (P2)

### 6. Нет таймаутов для upstream-запросов (axios)

**Файлы:**
- `packages/api/src/parsers/appStoreParser.ts` (строки 9, 37, 56)
- `packages/api/src/parsers/googlePlayParser.ts` (строки 41, 64, 79)

**Проблема:**
- Axios по умолчанию не имеет таймаута
- Медленные ответы upstream блокируют worker бесконечно

**План исправления:**
- [ ] Добавить глобальный таймаут для axios (30 секунд)
- [ ] Добавить retry с exponential backoff
- [ ] Реализовать семафор для ограничения конкурентных запросов
- [ ] Добавить кэширование результатов

---

### 7. CSV-инъекция формул

**Файл:** `packages/api/src/services/exportService.ts` (строки 34-39)

**Проблема:**
- Функция `escapeCsv` не нейтрализует формулы Excel
- Значения начинающиеся с `=`, `+`, `-`, `@`, `\t`, `\r` опасны

**План исправления:**
- [ ] Добавить проверку на опасные символы в начале строки
- [ ] Префиксировать опасные значения одинарной кавычкой или пробелом
- [ ] Добавить тесты для CSV-экспорта

---

### 8. Логирование заголовков запроса

**Файл:** `packages/api/src/app.ts` (строки 47-58)

**Проблема:**
- В режиме Netlify логируются все заголовки (включая auth-токены)
- Утечка приватных данных в логи

**План исправления:**
- [ ] Удалить Netlify-специфичное логирование полностью
- [ ] Создать whitelist безопасных заголовков для логирования
- [ ] Добавить редактирование sensitive данных

---

### 9. Нет валидации appId — потенциальный SSRF

**Файлы:**
- `packages/api/src/parsers/appStoreParser.ts` (строка 37)
- `packages/api/src/parsers/googlePlayParser.ts` (строка 64)

**Проблема:**
- `appId` приходит напрямую из пользовательского ввода
- Нет санитизации перед использованием в URL

**План исправления:**
- [ ] Добавить regex-валидацию для appId (только допустимые символы)
- [ ] Для Apple: только числовые ID
- [ ] Для Google: только `[a-zA-Z0-9._]+`

---

### 10. Клиент использует 5-минутный таймаут

**Файл:** `client/src/services/api.ts` (строка 19)

**Проблема:**
- Таймаут 300000ms (5 минут) слишком большой
- Потенциальный slowloris для API

**План исправления:**
- [ ] Уменьшить таймаут до разумного значения (60-120 секунд)
- [ ] Добавить индикатор прогресса для долгих операций
- [ ] Рассмотреть WebSocket или SSE для real-time обновлений

---

## Низкий приоритет (P3)

### 11. Invalid Date приводит к 500 ошибке

**Файл:** `packages/api/src/routes/api.ts` (строки 115-120)

**Проблема:**
- `new Date("invalid")` создаёт Invalid Date
- Вызов `.toISOString()` выбрасывает исключение

**План исправления:**
- [ ] Добавить валидацию дат перед созданием объекта Date
- [ ] Возвращать 400 Bad Request для невалидных дат

---

### 12. parseInt без проверки NaN

**Файл:** `packages/api/src/routes/api.ts` (строки 100-101)

**Проблема:**
- `parseInt("abc")` возвращает `NaN`
- NaN проходит дальше и ломает логику

**План исправления:**
- [ ] Добавить проверку `isNaN()` после parseInt
- [ ] Использовать значения по умолчанию при невалидном вводе

---

### 13. Нет валидации store/ratings

**Файл:** `packages/api/src/routes/api.ts` (строки 97-103)

**Проблема:**
- Поле `store` кастуется без проверки
- Можно передать любую строку

**План исправления:**
- [ ] Добавить enum-валидацию для `store`
- [ ] Проверять что `ratings` содержит только числа 1-5

---

### 14. Helmet без кастомизации CSP

**Файл:** `packages/api/src/app.ts` (строка 18)

**Проблема:**
- Helmet с дефолтными настройками
- CSP не настроен для фронтенда

**План исправления:**
- [ ] Настроить CSP для разрешённых источников
- [ ] Добавить HSTS, X-Frame-Options и другие заголовки

---

### 15. Нет graceful shutdown

**Проблема:**
- Нет обработки SIGTERM/SIGINT
- Активные запросы обрываются без cleanup

**План исправления:**
- [ ] Добавить обработчики сигналов
- [ ] Реализовать graceful shutdown с таймаутом
- [ ] Закрывать соединения с БД корректно

---

### 16. console.error логирует полный error object

**Файлы:** Все файлы с `console.error`

**Проблема:**
- Может утекать стек и sensitive данные

**План исправления:**
- [ ] Создать централизованный error handler
- [ ] Логировать только безопасную информацию
- [ ] В продакшене скрывать детали ошибок

---

## Задачи по удалению Netlify ✅ ЗАВЕРШЕНО

- [x] Удалить папку `netlify/functions/`
- [x] Удалить файл `netlify.toml`
- [x] Удалить `serverless-http` из `package.json`
- [x] Удалить все проверки `isNetlify` / `AWS_LAMBDA_FUNCTION_NAME`
- [x] Удалить Netlify-специфичное логирование
- [x] Удалить `client/public/_redirects` (Netlify redirects)
- [x] Удалить `client/railway.json` (Railway config)
- [x] Обновить README с актуальной информацией о деплое (Render)
- [x] Очистить комментарии в коде от упоминаний Netlify

---

## Порядок выполнения

1. **Фаза 1 — Удаление Netlify** (подготовка)
   - Удалить все Netlify-специфичные файлы и код
   - Упростить конфигурацию

2. **Фаза 2 — Критичные исправления (P0)**
   - Исправить загрузку SQLite
   - Добавить rate-limiting и базовую защиту

3. **Фаза 3 — Высокий приоритет (P1)**
   - Ограничить limit/total
   - Исправить CORS
   - Рефакторинг singleton'ов

4. **Фаза 4 — Средний приоритет (P2)**
   - Таймауты axios
   - CSV-санитизация
   - Валидация входных данных

5. **Фаза 5 — Низкий приоритет (P3)**
   - Остальные улучшения
   - Тесты
   - Документация

---

## Метрики успеха

- [ ] Все критичные уязвимости закрыты
- [ ] Сервер выдерживает нагрузку без OOM
- [ ] Rate-limiting работает корректно
- [ ] Нет утечек sensitive данных в логах
- [ ] CSV-экспорт безопасен для открытия в Excel
